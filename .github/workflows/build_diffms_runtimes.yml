name: Build and Upload DiffMS Runtimes

on:
  workflow_dispatch:
    inputs:
      clobber:
        description: 'Overwrite existing artifacts in the release'
        required: false
        default: 'true'
        type: boolean
  push:
    branches:
      - diffms-py-integration
      - 'feature/**'
      - 'fix/**'
# Removing paths restriction to ensure it triggers on any change to the branch during testing

permissions:
  contents: write

jobs:
  build_runtimes:
    name: Build runtimes
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x86_64
          - os: macos-latest
            platform: macos-arm64
          - os: windows-latest
            platform: windows-x86_64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          micromamba-version: "latest"
          cache-downloads: true
          cache-environment: false

      - name: Build DiffMS runtime packs (macOS/Linux)
        if: runner.os != 'Windows'
        shell: bash
        run: bash external_tools/diffms/runtime/build_runtime_packs.sh

      - name: Build DiffMS runtime packs (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: external_tools/diffms/runtime/build_runtime_packs.ps1

      - name: Upload to Release
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: diffms-runtimes
        run: |
          # Create release if it doesn't exist
          gh release view "$TAG" || gh release create "$TAG" --prerelease --title "DiffMS Python Runtimes" --notes "Pre-built Python runtimes for DiffMS. Used by CI and Gradle builds."
          
          # Upload all files from the output directory
          FILES=(external_tools/diffms/runtime-packs/*)
          if [ ${#FILES[@]} -gt 0 ]; then
            gh release upload "$TAG" "${FILES[@]}" --clobber
          else
            echo "No files found to upload"
            exit 1
          fi
